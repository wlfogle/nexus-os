# NexusOS ZFS Post-Configuration Module
# Comprehensive ZFS system configuration after installation
#
# SPDX-FileCopyrightText: 2024 NexusOS Project  
# SPDX-License-Identifier: GPL-3.0+
---

# ZFS pool name (should match the main ZFS configuration)
poolName: "rpool"

# Root dataset path
rootDataset: "rpool/ROOT/nexusos"

# Systemd services to enable for ZFS functionality
services:
    # Core ZFS services
    - "zfs-import-cache.service"
    - "zfs-import.target"
    - "zfs-mount.service"  
    - "zfs.target"
    - "zfs-zed.service"
    
    # ZFS maintenance services
    - "zfs-scrub-monthly@rpool.timer"
    - "zfs-trim@rpool.timer"

# ZFS module parameters to configure
moduleParameters:
    # Adaptive Replacement Cache (ARC) configuration
    zfs_arc_max: "2147483648"      # 2GB max ARC (adjust based on system RAM)
    zfs_arc_min: "536870912"       # 512MB min ARC
    zfs_arc_meta_limit: "1073741824"  # 1GB meta limit
    
    # Performance tuning
    zfs_prefetch_disable: "0"      # Enable prefetch
    zfs_vdev_async_read_max_active: "10"
    zfs_vdev_async_write_max_active: "10"
    zfs_vdev_sync_read_max_active: "10"
    zfs_vdev_sync_write_max_active: "10"
    
    # Transaction group settings
    zfs_txg_timeout: "5"           # 5 second TXG timeout
    zfs_dirty_data_max: "4294967296"  # 4GB dirty data max
    
    # Metaslab settings for better allocation
    zfs_metaslab_lba_weighting_enabled: "1"
    zfs_metaslab_bias_enabled: "1"

# ZFS Event Daemon (ZED) configuration
zed:
    # Email notifications (disabled by default)
    email_notifications: false
    email_address: "root@nexusos.local"
    
    # Event logging
    history_events: true
    log_level: "info"
    
    # Auto-replace failed drives (if supported)
    auto_replace: false
    
    # Spare disk management
    spare_on_io_errors: 1
    spare_on_checksum_errors: 10

# Automatic snapshot configuration
snapshots:
    enable: true
    
    # Snapshot retention policy
    retention:
        frequent: 4      # Keep 4 frequent snapshots (15 min intervals = 1 hour)
        hourly: 24       # Keep 24 hourly snapshots (1 day)
        daily: 31        # Keep 31 daily snapshots (1 month)
        weekly: 8        # Keep 8 weekly snapshots (2 months)
        monthly: 12      # Keep 12 monthly snapshots (1 year)
    
    # Datasets to snapshot (regex patterns)
    datasets:
        - "rpool/ROOT/nexusos"
        - "rpool/home"
        - "rpool/var"
        - "rpool/nexus"
    
    # Exclude patterns
    exclude:
        - "rpool/var/tmp"
        - "rpool/var/cache"
        - "*/tmp"
        - "*/cache"

# Automatic scrub configuration  
scrub:
    enable: true
    schedule: "monthly"     # monthly, weekly, or daily
    pools:
        - "rpool"
    
    # Scrub during specific hours (24-hour format)
    time_window:
        start: "02:00"
        end: "06:00"

# Automatic trim configuration for SSDs
trim:
    enable: true
    schedule: "weekly"      # weekly, monthly, or daily
    pools:
        - "rpool"

# Boot environment management
boot_environments:
    enable: true
    
    # Maximum number of boot environments to keep
    max_keep: 5
    
    # Automatically create BE before system updates
    auto_snapshot_before_update: true
    
    # BE naming scheme
    naming_scheme: "nexusos-%Y%m%d-%H%M%S"

# System file configurations to create/modify
system_files:
    # ZFS module configuration
    "/etc/modprobe.d/zfs.conf":
        content: |
            # NexusOS ZFS module parameters
            # Optimized for desktop and AI workloads
            
            # ARC settings
            options zfs zfs_arc_max=2147483648
            options zfs zfs_arc_min=536870912
            options zfs zfs_arc_meta_limit=1073741824
            
            # Performance tuning
            options zfs zfs_prefetch_disable=0
            options zfs zfs_vdev_async_read_max_active=10
            options zfs zfs_vdev_async_write_max_active=10
            
            # Transaction groups
            options zfs zfs_txg_timeout=5
            options zfs zfs_dirty_data_max=4294967296
            
            # Metaslab optimization
            options zfs zfs_metaslab_lba_weighting_enabled=1
            options zfs zfs_metaslab_bias_enabled=1
    
    # ZFS Event Daemon configuration
    "/etc/zfs/zed.d/zed.rc":
        content: |
            # NexusOS ZFS Event Daemon configuration
            
            # Email notifications (disabled)
            ZED_EMAIL_NOTIFICATIONS=0
            
            # Logging
            ZED_HISTORY_ENABLED=1
            ZED_LOG_LEVEL="info"
            
            # Auto-replace settings
            ZED_SPARE_ON_IO_ERRORS=1
            ZED_SPARE_ON_CHECKSUM_ERRORS=10
    
    # Systemd drop-in for ZFS import performance
    "/etc/systemd/system/zfs-import-cache.service.d/override.conf":
        content: |
            [Service]
            # Import with parallel processing for faster boot
            ExecStart=
            ExecStart=/usr/bin/zpool import -c /etc/zfs/zpool.cache -N -a
            # Increase timeout for large pools
            TimeoutSec=180
    
    # ZFS auto-snapshot configuration
    "/etc/zfs/auto-snapshot.conf":
        content: |
            # NexusOS ZFS auto-snapshot configuration
            
            # Enable auto-snapshots
            ENABLED=true
            
            # Retention settings
            FREQUENT_PERIOD=15  # 15 minutes
            FREQUENT_KEEP=4     # Keep 4 (1 hour total)
            HOURLY_KEEP=24      # Keep 24 (1 day total)
            DAILY_KEEP=31       # Keep 31 (1 month total)
            WEEKLY_KEEP=8       # Keep 8 (2 months total)  
            MONTHLY_KEEP=12     # Keep 12 (1 year total)
            
            # Datasets to snapshot
            DATASETS="rpool/ROOT/nexusos,rpool/home,rpool/var,rpool/nexus"

# System optimization settings
system_optimization:
    # Kernel parameters for ZFS
    sysctl:
        # Virtual memory settings for ZFS
        vm.swappiness: 1
        vm.vfs_cache_pressure: 50
        vm.dirty_ratio: 5
        vm.dirty_background_ratio: 2
        
        # Network buffer sizes (if NFS/iSCSI is used)
        net.core.rmem_max: 16777216
        net.core.wmem_max: 16777216
        
        # File system settings
        fs.file-max: 2097152
    
    # I/O scheduler settings for ZFS
    io_scheduler:
        # Use none/noop for NVMe, mq-deadline for SATA
        nvme: "none"
        sata: "mq-deadline"
        
    # CPU governor for performance
    cpu_governor: "performance"

# Package manager integration
packages:
    # Essential ZFS utilities to ensure are installed
    required:
        - "zfs-utils"
        - "zfs-dkms"  
        - "grub-zfs-fixer"
        
    # Optional but recommended packages
    optional:
        - "zfs-auto-snapshot"
        - "sanoid"
        - "pv"           # For progress display during operations
        - "mbuffer"      # For buffered transfers

# Monitoring and alerting
monitoring:
    # Enable ZFS health monitoring
    health_check:
        enable: true
        interval: "hourly"
        
        # Alert thresholds
        scrub_age_warning: 35    # days
        scrub_age_critical: 60   # days
        
        # Pool health alerts
        alert_on_degraded: true
        alert_on_faulted: true
        alert_on_offline: true
        
    # Log rotation for ZFS logs
    log_rotation:
        "/var/log/zfs-zed.log": "weekly rotate 4 compress delaycompress"

# Development and debugging options
debug:
    # Enable additional logging during development
    verbose_logging: false
    
    # Create debug snapshots
    debug_snapshots: false
    
    # Performance monitoring
    enable_zfs_stats: true