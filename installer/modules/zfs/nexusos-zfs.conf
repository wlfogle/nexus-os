# NexusOS ZFS Configuration
# Enhanced ZFS settings optimized for NexusOS performance and reliability
#
# SPDX-FileCopyrightText: 2024 NexusOS Project
# SPDX-License-Identifier: GPL-3.0+
---

# Pool name for the ZFS root pool
# This will be the main pool containing the operating system
poolName: rpool

# ZFS pool creation options
# Optimized for modern SSDs and performance
poolOptions: >-
    -f
    -o ashift=12
    -O mountpoint=none
    -O acltype=posixacl
    -O relatime=on
    -O compression=zstd-3
    -O xattr=sa
    -O autotrim=on
    -O encryption=on
    -O keyformat=passphrase
    -O keylocation=prompt
    -O recordsize=1M

# Dataset creation options
# Optimized for different use cases
datasetOptions: >-
    -o compression=zstd-3
    -o atime=off
    -o xattr=sa
    -o recordsize=128k

# NexusOS ZFS Dataset Layout
# Organized for optimal performance and management
datasets:
    # Root dataset - contains the OS
    ROOT:
        mountpoint: none
        options: >-
            -o canmount=off
            -o mountpoint=none
        
        # Main system dataset
        nexusos:
            mountpoint: /
            options: >-
                -o canmount=noauto
                -o mountpoint=/
                -o recordsize=128k
                -o compression=zstd-3

    # Home directory dataset
    home:
        mountpoint: /home
        options: >-
            -o compression=zstd-3
            -o recordsize=1M
            -o atime=off

    # Variable data
    var:
        mountpoint: /var
        options: >-
            -o compression=lz4
            -o recordsize=128k
            -o atime=off
        
        # System logs
        log:
            mountpoint: /var/log
            options: >-
                -o compression=gzip-9
                -o recordsize=64k
                -o atime=off
                -o logbias=throughput
        
        # Package cache
        cache:
            mountpoint: /var/cache
            options: >-
                -o compression=lz4
                -o recordsize=1M
                -o atime=off
        
        # Temporary files
        tmp:
            mountpoint: /var/tmp
            options: >-
                -o compression=lz4
                -o recordsize=128k
                -o atime=off
                -o sync=disabled

    # Optional datasets for development and AI workloads
    opt:
        mountpoint: /opt
        options: >-
            -o compression=zstd-3
            -o recordsize=1M
            -o atime=off

    # Container storage (if Docker/Podman is used)
    containers:
        mountpoint: /var/lib/containers
        options: >-
            -o compression=zstd-3
            -o recordsize=64k
            -o atime=off
            -o quota=50G

    # AI models and datasets storage
    nexus:
        mountpoint: none
        options: >-
            -o canmount=off
            -o mountpoint=none
        
        # AI models
        models:
            mountpoint: /nexus/models
            options: >-
                -o compression=zstd-3
                -o recordsize=1M
                -o atime=off
                -o quota=100G
        
        # AI datasets
        data:
            mountpoint: /nexus/data
            options: >-
                -o compression=zstd-3
                -o recordsize=1M
                -o atime=off
                -o quota=200G

# Boot pool configuration (separate pool for /boot if needed)
bootPool:
    create: false  # Set to true if separate boot pool is required
    poolName: bpool
    poolOptions: >-
        -f
        -o ashift=12
        -O mountpoint=none
        -O compression=lz4_compress
        -O acltype=posixacl
        -O xattr=sa
        -O relatime=on

# ZFS module parameters for optimal performance
moduleParameters:
    # ARC (Adaptive Replacement Cache) settings
    zfs_arc_max: "2147483648"  # 2GB max ARC size
    zfs_arc_min: "536870912"   # 512MB min ARC size
    
    # Prefetch settings
    zfs_prefetch_disable: "0"
    zfs_vdev_async_read_max_active: "10"
    zfs_vdev_async_write_max_active: "10"
    
    # Transaction group settings
    zfs_txg_timeout: "5"
    
    # Metaslab settings
    zfs_metaslab_lba_weighting_enabled: "1"

# Post-installation ZFS optimization
postInstall:
    # Services to enable
    services:
        - zfs-import-cache.service
        - zfs-import.target  
        - zfs-mount.service
        - zfs.target
        - zfs-zed.service
    
    # ZFS Event Daemon configuration
    zed:
        email_notifications: false
        history_events: true
        
    # Automatic snapshots configuration
    snapshots:
        enable: true
        # Snapshot schedule using systemd timers
        schedule:
            frequent: "15min"    # Keep 4 (1 hour)
            hourly: "1hour"      # Keep 24 (1 day)
            daily: "1day"        # Keep 31 (1 month)
            weekly: "1week"      # Keep 8 (2 months)
            monthly: "1month"    # Keep 12 (1 year)
    
    # Automatic scrub schedule
    scrub:
        enable: true
        schedule: "monthly"
    
    # Trim schedule for SSDs
    trim:
        enable: true
        schedule: "weekly"

# GRUB configuration for ZFS boot
grub:
    # ZFS-specific GRUB settings
    cmdline_default: >-
        quiet
        splash
        zfs=rpool/ROOT/nexusos
        rw
    
    # Enable ZFS support in GRUB
    enable_zfs: true
    
    # Preload ZFS module
    preload_modules:
        - zfs
        - part_gpt
        - part_msdos

# Initramfs configuration
initramfs:
    # Hooks to include for ZFS support
    hooks:
        - base
        - udev
        - autodetect
        - modconf
        - kms
        - keyboard
        - keymap
        - consolefont
        - block
        - zfs
        - filesystems
        - fsck
    
    # Modules to include
    modules:
        - zfs
        - spl
    
    # Files to include
    files:
        - /etc/hostid
        - /etc/zfs/zpool.cache

# Backup and recovery settings
backup:
    # Automatic dataset replication
    replication:
        enable: false
        destination: "backup-server:/backup/nexusos"
    
    # Boot environment management
    boot_environments:
        enable: true
        keep_count: 5
        auto_snapshot_before_update: true